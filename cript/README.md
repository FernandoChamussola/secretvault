# Secrets Vault ğŸ”

A secure, self-hosted secrets management system with **AES-256-GCM encryption** for storing passwords, API keys, and sensitive notes.

## âš ï¸ Security Warning

**THIS IS A TEST/EDUCATIONAL PROJECT**

- **DO NOT** use in production without a comprehensive security audit
- **DO NOT** expose to the public internet without additional hardening
- **DO NOT** store highly sensitive production secrets without additional security layers
- For production use, consider enterprise solutions like HashiCorp Vault, AWS Secrets Manager, or Azure Key Vault

## ğŸ¯ Features

- **Strong Encryption**: AES-256-GCM authenticated encryption for all secrets
- **User Authentication**: JWT-based authentication with bcrypt password hashing
- **Authorization**: Each user can only access their own secrets
- **Audit Logging**: All critical operations are logged with timestamps
- **Rate Limiting**: Protection against brute-force attacks
- **Input Validation**: Comprehensive validation on all inputs
- **Docker Compose**: Easy deployment with all services containerized
- **Nginx Reverse Proxy**: Ready for HTTPS with Let's Encrypt

## ğŸ“ Project Structure

```
cript/
â”œâ”€â”€ backend/                 # Node.js API server
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ config/         # Database configuration
â”‚   â”‚   â”œâ”€â”€ middleware/     # Auth, validation, error handling
â”‚   â”‚   â”œâ”€â”€ routes/         # API routes (auth, secrets)
â”‚   â”‚   â”œâ”€â”€ utils/          # Crypto, logging utilities
â”‚   â”‚   â””â”€â”€ index.js        # Application entry point
â”‚   â”œâ”€â”€ scripts/            # Test scripts
â”‚   â”œâ”€â”€ Dockerfile
â”‚   â””â”€â”€ package.json
â”œâ”€â”€ frontend/               # Next.js frontend
â”‚   â”œâ”€â”€ pages/             # Login, register, secrets management
â”‚   â”œâ”€â”€ lib/               # API client
â”‚   â”œâ”€â”€ styles/            # CSS modules
â”‚   â”œâ”€â”€ Dockerfile
â”‚   â””â”€â”€ package.json
â”œâ”€â”€ db/                    # Database initialization
â”‚   â””â”€â”€ init.sql           # Database schema
â”œâ”€â”€ nginx/                 # Nginx reverse proxy
â”‚   â”œâ”€â”€ nginx.conf
â”‚   â”œâ”€â”€ conf.d/
â”‚   â””â”€â”€ ssl/              # SSL certificates (not included)
â”œâ”€â”€ scripts/              # Utility scripts
â”‚   â””â”€â”€ generate-keys.js  # Key generation tool
â”œâ”€â”€ docker-compose.yml
â”œâ”€â”€ .env.example
â””â”€â”€ README.md
```

## ğŸš€ Quick Start

### Prerequisites

- Docker and Docker Compose
- Node.js 20+ (for local development)
- OpenSSL (for key generation)

### Step 1: Generate Security Keys

```bash
# Option A: Use the provided script (recommended)
node scripts/generate-keys.js

# Option B: Generate manually
openssl rand -hex 32    # MASTER_KEY (64 hex characters = 32 bytes)
openssl rand -base64 32 # JWT_SECRET
```

The script will automatically create:
- `.env` file with all necessary keys
- `secrets/master_key.txt` (for Docker secret method)

### Step 2: Review the .env File

```bash
# The .env file should contain (generated by script):
DB_ROOT_PASSWORD=<generated>
DB_PASSWORD=<generated>
JWT_SECRET=<generated>
MASTER_KEY=<generated-64-character-hex-string>
```

**CRITICAL**: The `MASTER_KEY` is used to encrypt/decrypt ALL secrets. Store it securely!

### Step 3: Start the Application

```bash
# Start all services
docker compose up -d

# Check status
docker compose ps

# View logs
docker compose logs -f
```

Services will be available at:
- **Frontend**: http://localhost:80
- **Backend API**: http://localhost:80/api (proxied via nginx)
- **Database**: Internal network only (not exposed)

### Step 4: Test the Application

```bash
# Run the example test script
docker compose exec backend npm test

# Or manually:
# 1. Open http://localhost in your browser
# 2. Register a new account
# 3. Login
# 4. Create, view, and manage secrets
```

## ğŸ” Security Architecture

### Encryption Details

**Algorithm**: AES-256-GCM (Galois/Counter Mode)

- **Key Size**: 256 bits (32 bytes)
- **IV Size**: 96 bits (12 bytes) - randomly generated per encryption
- **Auth Tag**: 128 bits (16 bytes) - provides integrity verification
- **Master Key**: Never stored in code, only in environment/Docker secret

**How it works**:

1. User creates a secret with plaintext value
2. Backend generates a random IV for this encryption
3. AES-256-GCM encrypts the value using MASTER_KEY + IV
4. Encrypted value, IV, and auth tag are stored in database
5. On retrieval, backend decrypts using the same MASTER_KEY + stored IV
6. Auth tag verifies data hasn't been tampered with

**Database Storage**:
```sql
secrets table:
- value_encrypted: hex-encoded encrypted data
- iv: hex-encoded initialization vector (unique per secret)
- auth_tag: hex-encoded authentication tag (integrity check)
```

### Authentication Flow

1. **Registration**: Password hashed with bcrypt (12 rounds)
2. **Login**: Password verified, JWT token issued (24h expiry)
3. **API Access**: Token required in `Authorization: Bearer <token>` header
4. **Authorization**: Users can only access their own secrets

### Security Features

- âœ… **No plaintext storage**: All secrets encrypted at rest
- âœ… **Authentication**: JWT with bcrypt password hashing
- âœ… **Authorization**: Row-level security (users can't access others' secrets)
- âœ… **Rate limiting**: 5 login attempts per 15 minutes per IP
- âœ… **Input validation**: All inputs sanitized and validated
- âœ… **Audit logging**: All operations logged (without sensitive data)
- âœ… **Secure headers**: Helmet.js + Nginx security headers
- âœ… **Docker secrets**: Support for Docker secret files
- âœ… **Non-root containers**: All containers run as non-root users

## ğŸ“– API Documentation

### Authentication Endpoints

#### Register User
```http
POST /api/auth/register
Content-Type: application/json

{
  "username": "johndoe",
  "password": "SecurePass123!"
}
```

**Requirements**:
- Username: 3-50 characters, alphanumeric + `_-`
- Password: 8+ characters, must contain uppercase, lowercase, and number

#### Login
```http
POST /api/auth/login
Content-Type: application/json

{
  "username": "johndoe",
  "password": "SecurePass123!"
}
```

**Response**:
```json
{
  "token": "eyJhbGciOiJIUzI1NiIs...",
  "user": {
    "id": 1,
    "username": "johndoe"
  }
}
```

### Secrets Endpoints

All endpoints require `Authorization: Bearer <token>` header.

#### Create Secret
```http
POST /api/secrets
Authorization: Bearer <token>
Content-Type: application/json

{
  "name": "AWS API Key",
  "value": "AKIAIOSFODNN7EXAMPLE",
  "notes": "Production AWS key"
}
```

#### List Secrets (metadata only)
```http
GET /api/secrets
Authorization: Bearer <token>
```

**Response**:
```json
{
  "secrets": [
    {
      "id": 1,
      "name": "AWS API Key",
      "notes": "Production AWS key",
      "createdAt": "2025-01-15T10:30:00Z",
      "updatedAt": "2025-01-15T10:30:00Z"
    }
  ]
}
```

#### Get Secret (includes decrypted value)
```http
GET /api/secrets/:id
Authorization: Bearer <token>
```

**Response**:
```json
{
  "id": 1,
  "name": "AWS API Key",
  "value": "AKIAIOSFODNN7EXAMPLE",
  "notes": "Production AWS key",
  "createdAt": "2025-01-15T10:30:00Z",
  "updatedAt": "2025-01-15T10:30:00Z"
}
```

#### Update Secret
```http
PUT /api/secrets/:id
Authorization: Bearer <token>
Content-Type: application/json

{
  "name": "AWS API Key (Updated)",
  "value": "NEW_KEY_VALUE",
  "notes": "Updated notes"
}
```

All fields are optional. Value will be re-encrypted if provided.

#### Delete Secret
```http
DELETE /api/secrets/:id
Authorization: Bearer <token>
```

## ğŸ”§ Configuration

### Environment Variables

| Variable | Description | Example |
|----------|-------------|---------|
| `MASTER_KEY` | **CRITICAL** AES-256 key for encryption | `a1b2c3...` (64 hex) |
| `MASTER_KEY_FILE` | Alternative: path to file with key | `/run/secrets/master_key` |
| `JWT_SECRET` | Secret for signing JWT tokens | `base64string...` |
| `DB_HOST` | Database hostname | `db` |
| `DB_PORT` | Database port | `3306` |
| `DB_NAME` | Database name | `secrets_vault` |
| `DB_USER` | Database user | `secrets_user` |
| `DB_PASSWORD` | Database password | `strong-password` |
| `DB_ROOT_PASSWORD` | MySQL root password | `root-password` |
| `NODE_ENV` | Environment | `production` |
| `PORT` | Backend port | `3001` |

### Using Docker Secrets (Recommended for Production)

```bash
# Create secrets directory
mkdir -p secrets
chmod 700 secrets

# Store master key in file
echo "your-64-char-hex-key" > secrets/master_key.txt
chmod 600 secrets/master_key.txt

# Update .env - remove MASTER_KEY line
# Key will be read from secrets/master_key.txt
```

Docker Compose will mount this as `/run/secrets/master_key` in the container.

## ğŸŒ HTTPS Setup with Let's Encrypt

### Step 1: Update Nginx Configuration

Edit `nginx/conf.d/default.conf`:

```nginx
server {
    listen 80;
    server_name your-domain.com;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name your-domain.com;

    ssl_certificate /etc/nginx/ssl/fullchain.pem;
    ssl_certificate_key /etc/nginx/ssl/privkey.pem;

    # ... rest of configuration
}
```

### Step 2: Obtain Certificates

```bash
# Install certbot
sudo apt install certbot

# Obtain certificate (DNS or HTTP-01 challenge)
sudo certbot certonly --standalone -d your-domain.com

# Copy certificates to project
sudo cp /etc/letsencrypt/live/your-domain.com/fullchain.pem nginx/ssl/
sudo cp /etc/letsencrypt/live/your-domain.com/privkey.pem nginx/ssl/
sudo chmod 644 nginx/ssl/fullchain.pem
sudo chmod 600 nginx/ssl/privkey.pem
```

### Step 3: Restart Nginx

```bash
docker compose restart nginx
```

### Step 4: Setup Auto-Renewal

```bash
# Add to crontab
0 3 * * * certbot renew --quiet && docker compose restart nginx
```

## ğŸ“Š Monitoring and Logs

### View Logs

```bash
# All services
docker compose logs -f

# Specific service
docker compose logs -f backend
docker compose logs -f frontend
docker compose logs -f db
docker compose logs -f nginx

# Audit logs (inside backend container)
docker compose exec backend cat logs/audit.log

# Error logs
docker compose exec backend cat logs/error.log
```

### Audit Log Format

```json
{
  "event": "secret_created",
  "timestamp": "2025-01-15T10:30:00.000Z",
  "user_id": 1,
  "username": "johndoe",
  "secret_id": 5,
  "secret_name": "AWS API Key"
}
```

**Logged Events**:
- `user_registered`
- `login_success` / `login_failed`
- `secret_created`
- `secret_read`
- `secret_updated`
- `secret_deleted`
- `secret_decrypt_failed`

## ğŸ’¾ Backup and Recovery

### Backup Database

```bash
# Backup (encrypted values included)
docker compose exec db mysqldump \
  -u secrets_user -p secrets_vault > backup.sql

# The backup contains:
# - Encrypted secret values
# - IVs and auth tags
# - User data (hashed passwords)
```

**IMPORTANT**: Backups contain encrypted data. You MUST also backup the MASTER_KEY separately!

### Restore Database

```bash
# Restore
docker compose exec -T db mysql \
  -u secrets_user -p secrets_vault < backup.sql
```

### Backup Master Key

```bash
# Export master key (SECURE THIS!)
cat .env | grep MASTER_KEY > master_key_backup.txt

# Or from Docker secret
cat secrets/master_key.txt > master_key_backup.txt

# STORE IN SECURE LOCATION:
# - Password manager
# - Encrypted USB drive
# - Hardware security module (HSM)
# - Cloud KMS (AWS/Azure/GCP)
```

âš ï¸ **WITHOUT THE MASTER_KEY, ALL ENCRYPTED DATA IS PERMANENTLY LOST!**

## ğŸ›¡ï¸ Security Best Practices

### For Testing/Development

âœ… **DO**:
- Use strong, unique MASTER_KEY
- Keep `.env` file secure (chmod 600)
- Test on isolated network/localhost
- Use different keys for different environments

âŒ **DON'T**:
- Commit `.env` or keys to git
- Share keys via insecure channels
- Use default/example keys
- Expose to public internet

### For Production Deployment

1. **Use HSM/KMS**:
   - AWS KMS / Secrets Manager
   - Azure Key Vault
   - Google Cloud KMS
   - HashiCorp Vault

2. **Enable HTTPS**:
   - Use Let's Encrypt certificates
   - Enable HSTS headers
   - Disable HTTP (redirect to HTTPS)

3. **Network Security**:
   - Use firewall rules
   - VPN/VPC for access
   - DDoS protection (Cloudflare, AWS Shield)
   - Intrusion detection (fail2ban, Wazuh)

4. **Application Security**:
   - Implement MFA (TOTP/WebAuthn)
   - Session management improvements
   - API rate limiting per user
   - Regular security updates

5. **Monitoring**:
   - Log aggregation (ELK, Splunk)
   - Alerting on suspicious activity
   - Regular audit log reviews
   - Intrusion detection

6. **Backup**:
   - Automated encrypted backups
   - Separate MASTER_KEY backup
   - Test restore procedures
   - Off-site backup storage

7. **Access Control**:
   - Principle of least privilege
   - Regular access reviews
   - Key rotation policy
   - Secret expiration

## ğŸ”„ Key Rotation

### Rotating the Master Key

**This is a complex operation requiring downtime:**

1. **Backup everything** (database + current MASTER_KEY)
2. Generate new MASTER_KEY: `openssl rand -hex 32`
3. Stop the application: `docker compose down`
4. Create a migration script to:
   - Decrypt all secrets with old key
   - Re-encrypt with new key
   - Update IVs and auth tags
5. Update `.env` or Docker secret with new key
6. Start application: `docker compose up -d`
7. Verify all secrets can be decrypted
8. Securely destroy old MASTER_KEY

**Note**: This requires custom migration code not included in this project.

## ğŸ› Troubleshooting

### "MASTER_KEY not configured"

```bash
# Check if MASTER_KEY is set
cat .env | grep MASTER_KEY

# If empty, generate new key
node scripts/generate-keys.js
```

### "Failed to decrypt secret"

Possible causes:
- MASTER_KEY changed (data encrypted with different key)
- Database corruption
- IV or auth tag corruption

**Solution**: Restore from backup with correct MASTER_KEY

### "Database connection failed"

```bash
# Check database status
docker compose ps db

# Check database logs
docker compose logs db

# Verify credentials in .env
```

### "Token expired"

JWT tokens expire after 24 hours. Login again to get a new token.

## ğŸ“š Additional Resources

- [OWASP Cryptographic Storage Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Cryptographic_Storage_Cheat_Sheet.html)
- [NIST Guidelines on Encryption](https://csrc.nist.gov/publications/detail/sp/800-175b/rev-1/final)
- [Node.js Crypto Documentation](https://nodejs.org/api/crypto.html)
- [Docker Secrets Guide](https://docs.docker.com/engine/swarm/secrets/)

## ğŸ“ License

MIT License - See LICENSE file for details

## ğŸ¤ Contributing

This is an educational project. Contributions welcome for:
- Security improvements
- Additional features (MFA, key rotation, etc.)
- Documentation improvements
- Bug fixes

## âš–ï¸ Disclaimer

This software is provided "as is" without warranty of any kind. Use at your own risk. The authors are not responsible for any data loss, security breaches, or other issues that may arise from using this software.

For production use cases, please conduct a thorough security audit and consider enterprise-grade solutions.

---

**Remember**: The security of your secrets is only as strong as the weakest link in your security chain. Protect your MASTER_KEY with extreme care! ğŸ”
